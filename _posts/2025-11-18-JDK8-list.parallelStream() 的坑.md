---
title: JDK8-list.parallelStream() 的坑
author: nhsoft.lsd
date: 2025-11-18
categories: [Java]
pin: false
---

`list.parallelStream() ` 默认使用 **全局公共 ForkJoinPool（ForkJoinPool.commonPool()）**。 因为是全局的，
会导致如果线程池用完，其他 parallelStream 就会卡死。问题非常不好找

---

## 它使用哪个线程池？

当你调用 `parallelStream()` 时，JDK 会把任务提交到：

```java
ForkJoinPool.commonPool()
```

* 这是一个 **全局共享、所有并行流都会复用** 的线程池
* 默认线程数 = `CPU核心数 - 1`（如果 <=1 则 =1）
* 无法简单方式为单个 `parallelStream` 自定义线程池

---

## 潜在风险和问题

### **1）线程池被抢占 / 业务阻塞**

CommonPool 是共享资源，如果其他代码（例如某个框架内部）也在使用它，可能导致长时间任务阻塞全部 parallelStream：

```java
parallelStream 内部执行 I/O、网络请求、数据库操作
```

结果可能是：

* 整个应用吞吐量下降
* Web请求线程阻塞等待
* 甚至造成**死锁风险**

---

### **2）parallelStream 不适合有阻塞操作**

ForkJoinPool 设计理念是 CPU 密集型任务（计算任务），不是 I/O 密集型：

| 类型                 | 是否适合 parallelStream |
| ------------------ | ------------------- |
| CPU 密集任务           | ✔ 推荐                |
| I/O / DB / HTTP 调用 | ❌ 容易卡死线程池           |

---

### **3）不易管理、难定位问题**

* 无法指定队列长度、拒绝策略
* 全局池异常会影响全局代码
* Debug & Metrics 都不友好

---

## 如何安全使用？

### **方法一：自己定义线程池 + `parallel()`**

```java
ForkJoinPool customPool = new ForkJoinPool(20);
customPool.submit(() -> imageList.parallelStream().forEach(this::handle)).join();
```

### **方法二：直接用 `ExecutorService` + `CompletableFuture`**

```java
ExecutorService pool = Executors.newFixedThreadPool(20);
List<CompletableFuture<Void>> futures =
    imageList.stream()
        .map(img -> CompletableFuture.runAsync(() -> handle(img), pool))
        .toList();
CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
```

---

## 总结

| 问题             | 说明                                   |
| -------------- | ------------------------------------ |
| 使用哪个线程池？       | ForkJoinPool.commonPool()            |
| 默认线程数          | CPU 核心数 - 1                          |
| 风险             | 抢占 & 阻塞 & 调优难                        |
| 是否可用于 I/O 密集型？ | ❌ 不推荐                                |
| 推荐替代           | 自定义线程池 / CompletableFuture / Reactor |

![weixin.png](/assets/img/nhsoft_lsd/weixin.png)

<div style="text-align: center;">公众号名称：怪味Coding</div>
<div style="text-align: center;">微信扫码关注或搜索公众号名称</div>
